<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<style>
		.borders {
			border: 1px dashed darkgrey;
		}
	</style>
</head>
<body>
	<div id="directors"></div>
	<script>
		var directors = {}; //map of director url to DOM elements

		var Director = function(url) {
			this.url = url ? url : "";
			this.vms = [];
		};

		Director.prototype.render = function() {
			this.createDirector(document.getElementById("directors"));
		};

		Director.prototype.createDirector = function(parentEl) {
			var div = document.createElement("div"),
				title = document.createElement("h3"),
				name = this.url;

			div.classList.add("director");
			div.classList.add("container-fluid");
			div.classList.add("borders");			
			directors[name] = div;

			title.classList.add("text-center");
			title.textContent = "Director: " + name;
			div.appendChild(title);

			this.createDeployments(div, this.vms);
			parentEl.appendChild(div);
		};

		Director.prototype.createDeployments = function(parentEl, deployments) {
			for (var i = 0; i < deployments.length; i++) {
				this.createDeployment(parentEl, deployments[i]);
			}
		};

		Director.prototype.createDeployment = function(parentEl, deployment) {
			var div = document.createElement("div"),
				title = document.createElement("h4"),
				name = deployment.deploymentName;

			div.classList.add("deployment");
			div.classList.add("container-fluid");
			div.classList.add("borders");

			title.textContent = "Deployment: " + name;
			div.appendChild(title);

			this.createVms(div, deployment.vms);
			parentEl.appendChild(div);
		};

		Director.prototype.createVms = function(parentEl, vms) {
			for (var i = 0; i < vms.length; i++) {
				this.createVm(parentEl, vms[i]);
			}
		};

		Director.prototype.createVm = function(parentEl, vm) {
			var div = document.createElement("div"),
				name = vm.name + " | " + vm.ip;

			div.classList.add("vm");
			div.classList.add("container-fluid");
			div.classList.add("borders");

			switch (vm.state) {
				case "running":
					div.classList.add("bg-success");
					break;
				case "failing":
					div.classList.add("bg-danger");
					break;
				case "unresponsive":
					div.classList.add("bg-muted");
					break;
			}

			div.textContent = name;
			parentEl.appendChild(div);
		};

    $(document).ready(function() {
      console.log("getting api")
      //start_spin
      $.get("/api", function(vmsData) {
        //stop_spin
        var vmsObj = JSON.parse(vmsData)
        console.log(vmsObj)
        var director = new Director("ci-ipsec.security.cf-app.com")
        director.vms = [vmsObj]
        director.render()
      });
    });
	</script>	
</body>
