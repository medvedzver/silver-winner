<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<style>
		.stupid-borders {
			border: 1px dashed darkgrey;
		}
	</style>
</head>
<body>
	<div id="directors"></div>
	<script>
		var directors = {}; //map of director url to DOM elements

		var Director = function(url) {
			this.url = url ? url : "";
			this.vms = [];
		};

		Director.prototype.render = function() {
			this.createDirector(document.getElementById("directors"));
		};

		Director.prototype.createDirector = function(parentEl) {
			var div = document.createElement("div"),
				name = this.url;

			div.classList.add("director");
			div.classList.add("container-fluid");
			div.classList.add("stupid-borders");
			div.textContent = name;
			directors[name] = div;
			this.createDeployments(div, this.vms);
			parentEl.appendChild(div);
		};

		Director.prototype.createDeployments = function(parentEl, deployments) {
			for (var i = 0; i < deployments.length; i++) {
				this.createDeployment(parentEl, deployments[i]);
			}
		};

		Director.prototype.createDeployment = function(parentEl, deployment) {
			var div = document.createElement("div"),
				name = deployment.deploymentName;

			div.classList.add("deployment");
			div.classList.add("container-fluid");
			div.classList.add("stupid-borders");
			div.textContent = name;
			this.createVms(div, deployment.vms);
			parentEl.appendChild(div);
		};

		Director.prototype.createVms = function(parentEl, vms) {
			for (var i = 0; i < vms.length; i++) {
				this.createVm(parentEl, vms[i]);
			}
		};

		Director.prototype.createVm = function(parentEl, vm) {
			var div = document.createElement("div"),
				name = vm.name + " | " + vm.ip;

			div.classList.add("vm");
			div.classList.add("container-fluid");
			div.classList.add("stupid-borders");
			div.textContent = name;
			parentEl.appendChild(div);
		};

		$.ready($.get("https://s3-us-west-1.amazonaws.com/bosh-vis-data/vms-vitals-parsed", function(vmsData) {
			var director = new Director("ci-ipsec.security.cf-app.com"),
				deploymentCount = -1,
				vms = director.vms,
				reDeployment = new RegExp('deployment', 'i');
				reVm = new RegExp('\\|');

			vmsData.split("\n").forEach(function parseString(line) {
				if (line.search(reDeployment) !== -1) {
					vms[++deploymentCount] = {
						"deploymentName": line.split("`")[1].split("'")[0],
						"vms": []
					};
				} else if (line.search(reVm) !== -1) {
					var vmData = line.split("|");

					vms[deploymentCount].vms.push({
						"name": vmData[1].trim(),
						"state": vmData[2].trim(),
						"ip": vmData[4].trim(),
						"cpuUser": vmData[6].trim(),
						"ram": vmData[9].trim(),
						"ephemeralDiskUsage": vmData[12].trim()
					});
				}
			});

			console.log(director);
			director.render();
		}));
	</script>	
</body>